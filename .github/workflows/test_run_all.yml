name: Test Run All Benchmarks

on:
  workflow_dispatch:

jobs:
  run-benchmarks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.PRIVKEY }}

    - name: Stop existing benchmarks and prepare environment
      run: |
        ssh -o StrictHostKeyChecking=no root@168.119.5.82 << 'EOF'
          cd /root/benchmarks/benchmarks-data-demo
          ./stop.sh
          cd ../
          date=$(date +%Y-%m-%d)
          resultDir="results-$date"
          python3 ./update_time.py $date
        EOF

    - name: Run gas benchmarks
      run: |
        ssh -o StrictHostKeyChecking=no root@168.119.5.82 << 'EOF'
          cd /root/benchmarks/gas-benchmarks
          git pull
          ./run.sh \
            -t "tests/" \
            -w "warmup/warmup-1000bl-16wi-24tx.txt" \
            -c "nethermind,geth,reth,erigon,besu" \
            -r 1 \
            -o $resultDir
          cp $resultDir/reports/index.html ../gas-data-demo/gas/$date.html
          cp $resultDir/reports/result.json ../gas-data-demo/gas/$date.json
        EOF

    - name: Run genesis init speed benchmarks
      run: |
        ssh -o StrictHostKeyChecking=no root@168.119.5.82 << 'EOF'
          cd /root/benchmarks/genesis-init-benchmarks
          git pull
          ./runSpeed.sh \
            -t "tests/" \
            -c "nethermind,reth,besu" \
            -r 1 \
            -o "$resultDir/speed" \
            -s 1,10
          cp $resultDir/speed/reports/speed.html ../gas-data-demo/genesis-init-memory/$date.html
          cp $resultDir/speed/reports/speed.json ../gas-data-demo/genesis-init-memory/$date.json
        EOF

    - name: Run genesis init memory benchmarks
      run: |
        ssh -o StrictHostKeyChecking=no root@168.119.5.82 << 'EOF'
          cd /root/benchmarks/genesis-init-benchmarks
          ./runMemory.sh \
            -t "tests/" \
            -c "nethermind,reth,besu" \
            -r 1 \
            -o "$resultDir/memory" \
            -s 1,10
          cp $resultDir/memory/reports/memory.html ../gas-data-demo/genesis-init-memory/$date.html
          cp $resultDir/memory/reports/memory.json ../gas-data-demo/genesis-init-memory/$date.json
        EOF

    - name: Run burntpix benchmarks and push results
      run: |
        ssh -o StrictHostKeyChecking=no root@168.119.5.82 << 'EOF'
          cd /root/benchmarks/burntpix-benchmarks
          git pull
          ./run.sh \
            -t "testburnt/" \
            -w "./testburntwarm/warm.txt" \
            -c "nethermind,reth,besu" \
            -r 1 \
            -o $resultDir
          cp $resultDir/reports/index.html ../gas-data-demo/burntpix/$date.html
          cp $resultDir/reports/result.json ../gas-data-demo/burntpix/$date.json

          cd ../gas-data-demo
          ./push.sh
        EOF